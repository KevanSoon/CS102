<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Attendance System</title>
    <link rel="stylesheet" href="styles2.css">
</head>
<body>
    <div class="container">
        <!-- Header design matching the image -->
        <div class="header">
            <div class="header-left">
                <div class="logo-icon">ðŸ‘¤</div>
                <h1 class="header-title">Student Dashboard</h1>
            </div>
            <div class="header-right">
                <span class="welcome-text">Welcome, a@a</span>
                <button type="button" class="btn btn-primary" id="editProfileBtn" onclick="openEditProfileModal()">
                    Edit Profile
                </button>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Welcome section -->
        <div class="welcome-section">
            <h2 class="welcome-title">Welcome back!</h2>
            <p class="welcome-subtitle">Manage your class attendance and view your records</p>
        </div>

        <!-- Class selection section -->
        <div class="section-card">
            <div class="section-header">
                <h3 class="section-title">Select Class/Session</h3>
                <p class="section-subtitle">Available Classes</p>
            </div>
            <div class="section-content">
                <select class="form-select" id="classSelect" onchange="enableFaceScanning()">
                    <option value="">Select a class</option>
                    <option value="cs101">CS101 - Introduction to Programming</option>
                    <option value="math201">MATH201 - Calculus II</option>
                    <option value="phy301">PHY301 - Quantum Physics</option>
                </select>
                <!-- <button id="scanFaceBtn" class="btn btn-primary" style="width: 100%; margin-top: 1rem; display: none;" onclick="openFaceScanning()">
                    Scan Face for Attendance
                </button> -->
            </div>
        </div>

        <!-- Recent Attendance section -->
        <div class="section-card">
            <div class="section-header">
                <h3 class="section-title">Recent Attendance</h3>
            </div>
            <div class="section-content">
                <p class="welcome-subtitle">Your recent attendance records will appear here</p>
            </div>
        </div>
    </div>

    <!-- Face Scanning Modal -->
    <div id="faceScanModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Scan Face for Attendance</h3>
                <button class="close-btn" onclick="closeFaceScanning()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; color: #64748b; margin-bottom: 1rem;">
                    Position your face within the frame for attendance verification
                </p>
                <!-- <div class="camera-container" style="position: relative; background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 1rem;">
                    <video id="attendanceVideo" style="width: 100%; height: 300px; object-fit: cover;" autoplay muted></video>
                    <canvas id="attendanceCanvas" style="display: none;"></canvas>
                    <div class="scan-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px solid #22d3ee; border-radius: 50%; opacity: 0.8;"></div>
                </div> -->
                <div id="container">
                    <video id="video" autoplay muted playsinline></video>
                    <canvas id="canvas" width="360" height="240"></canvas>
                    <div id="overlay"></div>
                </div>
                 <div id="controls">
                <div>
                    <label>Image size</label>
                    (<label id="size-value">96</label>)
                    <br />
                    <input
                    id="size"
                    type="range"
                    min="64"
                    max="256"
                    step="32"
                    value="96"
                    disabled
                    />
                </div>
                <div>
                    <label>Threshold</label>
                    (<label id="threshold-value">0.85</label>)
                    <br />
                    <input
                    id="threshold"
                    type="range"
                    min="0.01"
                    max="1"
                    step="0.01"
                    value="0.85"
                    disabled
                    />
                </div>
                <div>
                    <label>Scale</label>
                    (<label id="scale-value">0.5</label>)
                    <br />
                    <input
                    id="scale"
                    type="range"
                    min="0.01"
                    max="1"
                    step="0.01"
                    value="0.5"
                    disabled
                    />
                </div>
                </div>
                <label id="status"></label>
                <div id="scanResult" style="text-align: center; margin-bottom: 1rem; display: none;">
                    <div style="color: #22c55e; font-weight: 500;">âœ“ Face verified successfully!</div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="scanBtn" class="btn btn-primary" style="flex: 1;" onclick="scanFace()">Scan Face</button>
                    <button id="markPresentBtn" class="btn btn-success" style="flex: 1; display: none;" onclick="markAttendance()">Mark Present</button>
                    <button class="btn btn-secondary" style="flex: 1;" onclick="closeFaceScanning()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal px-5" id="editProfileModal">
        <div class="modal-dialog px-5" style="width: 500px;">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeEditProfileModal()"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="form-group mb-3">
                        <label class="form-label" for="editName">Full Name</label>
                        <input type="text" id="editName" class="form-input form-control" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label" for="editEmail">Email</label>
                        <input type="email" id="editEmail" class="form-input form-control" required>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label" for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" class="form-input form-control" placeholder="Leave blank to keep current password">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label" for="editPassword">New Password</label>
                        <input type="password" id="editPassword" class="form-input form-control" placeholder="Leave blank to keep current password">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label class="form-label" for="editConfirmPassword">Confirm New Password</label>
                        <input type="password" id="editConfirmPassword" class="form-input form-control" placeholder="Confirm new password">
                    </div>
                    
                    <div id="editPasswordError" style="color: #ef4444; font-size: 0.875rem; margin-bottom: 1rem; display: none;">
                        Passwords do not match
                    </div>
                    
                    <div id="editSuccessMessage" class="alert alert-success" style="display: none;">
                        Profile updated successfully!
                    </div>
                    
                    <div id="editErrorMessage" class="alert alert-danger" style="display: none;">
                        Error updating profile. Please try again.
                    </div>
                </form>
            </div>
            
            <div class="modal-footer row">
                <button type="button" class="btn btn-secondary" onclick="closeEditProfileModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProfileChanges()">Save Changes</button>
            </div>
            
        </div>
    </div>
    
    <script type="module" src="src/student.js"></script>
    <script>
        // function openEditProfileModal() {
        //     document.getElementById("editProfileModal").classList.add("active");
        // }
        // Function to open the edit profile modal and populate with current user data
        function closeEditProfileModal() {
            document.getElementById("editProfileModal").classList.remove("active");
        }
        async function openEditProfileModal() {
        try {
            // Hardcoded user data for testing
            const user = {
                name: "John Doe",
                email: "john.doe@example.com"
            };
            
            // Original API call (commented out)
            // const response = await fetch('http://localhost:8080/api/user/profile');
            // if (!response.ok) {
            //     throw new Error('Failed to load user data');
            // }
            // const user = await response.json();
            
            // Populate form with current data
            document.getElementById('editName').value = user.name || '';
            document.getElementById('editEmail').value = user.email || '';
            
            // Clear password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('editPassword').value = '';
            document.getElementById('editConfirmPassword').value = '';
            
            // Hide error/success messages
            document.getElementById('editPasswordError').style.display = 'none';
            document.getElementById('editSuccessMessage').style.display = 'none';
            document.getElementById('editErrorMessage').style.display = 'none';
            
            document.getElementById("editProfileModal").classList.add("active");
            
        } catch (error) {
            console.error('Error loading profile:', error);
            alert('Error loading profile data');
        }
        }

        // Function to save profile changes
        async function saveProfileChanges() {
        // Get form values
        const name = document.getElementById('editName').value.trim();
        const email = document.getElementById('editEmail').value.trim();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('editPassword').value;
        const confirmPassword = document.getElementById('editConfirmPassword').value;
        
        // Hide previous messages
        document.getElementById('editPasswordError').style.display = 'none';
        document.getElementById('editSuccessMessage').style.display = 'none';
        document.getElementById('editErrorMessage').style.display = 'none';
        
        // Validate passwords if user is trying to change password
        if (newPassword || confirmPassword) {
            if (newPassword !== confirmPassword) {
                document.getElementById('editPasswordError').style.display = 'block';
                return;
            }
            
            if (!currentPassword) {
                alert('Please enter your current password to change it');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('New password must be at least 6 characters long');
                return;
            }
        }
        
        // Prepare update data
        const updateData = {
            name: name,
            email: email
        };
        
        // Add password fields only if user wants to change password
        if (newPassword) {
            updateData.currentPassword = currentPassword;
            updateData.newPassword = newPassword;
        }
        
        try {
            // Log the data that would be sent (for testing)
            console.log('Update data:', updateData);
            
            // Simulate successful update with hardcoded response
            const updatedUser = {
                id: "123e4567-e89b-12d3-a456-426614174000",
                name: name,
                email: email,
                updatedAt: new Date().toISOString()
            };
            
            // Original API call (commented out)
            // const response = await fetch('http://localhost:8080/api/user/profile', {
            //     method: 'PUT',
            //     headers: {
            //         'Content-Type': 'application/json'
            //     },
            //     body: JSON.stringify(updateData)
            // });
            // 
            // if (!response.ok) {
            //     const errorData = await response.json();
            //     throw new Error(errorData.message || 'Failed to update profile');
            // }
            // 
            // const updatedUser = await response.json();
            
            // Show success message
            document.getElementById('editSuccessMessage').style.display = 'block';
            
            // Update UI with new data if needed
            console.log('Profile updated:', updatedUser);
            
            // Close modal after 1.5 seconds
            setTimeout(() => {
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                modal.hide();
                
                // Optionally refresh the page or update displayed user info
                // location.reload();
            }, 1500);
            
        } catch (error) {
            console.error('Error updating profile:', error);
            document.getElementById('editErrorMessage').textContent = error.message;
            document.getElementById('editErrorMessage').style.display = 'block';
        }
        }

        
    </script>
</body>
</html>

