spring:
  datasource:
    url: ${SPRING_DATASOURCE_URL}
    username: ${SPRING_DATASOURCE_USERNAME}
    password: ${SPRING_DATASOURCE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    hikari:
      # Absolute minimum connection settings
      maximum-pool-size: 1              # Single connection
      minimum-idle: 0                   # No idle connections
      
      # Aggressive timeouts
      idle-timeout: 10000              # 10 seconds idle timeout
      max-lifetime: 30000              # 30 seconds max lifetime
      connection-timeout: 3000         # 3 seconds connection timeout
      validation-timeout: 2500         # Fast validation
      leak-detection-threshold: 10000  # Quick leak detection
      
      # Connection validation
      connection-test-query: SELECT 1
      validation-query: SELECT 1
      
      # Critical settings for connection cleanup
      auto-commit: false
      allow-pool-suspension: true
      register-mbeans: true            # Enable JMX monitoring
      
      # Pool identification
      pool-name: AttendanceHikariCP
      
      # Connection initialization
      initialization-fail-timeout: 1    # Fast fail on startup
      
      # Connection properties for PostgreSQL/Supabase
      data-source-properties:
        socketTimeout: 10
        loginTimeout: 3
        connectTimeout: 3
        tcpKeepAlive: true
        ApplicationName: cs102-attendance-app

  jpa:
    hibernate:
      ddl-auto: none                   # Disable automatic schema updates
    open-in-view: false               # Disable OSIV
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        connection:
          provider_disables_autocommit: true
          handling_mode: DELAYED_ACQUISITION_AND_RELEASE_AFTER_STATEMENT
        jdbc:
          time_zone: UTC
          batch_size: 15
          fetch_size: 15
        query:
          timeout: 10                  # 10 seconds query timeout
        session:
          events:
            log:
              LOG_QUERIES_SLOWER_THAN_MS: 5000
        generate_statistics: false     # Disable statistics
        temp:
          use_jdbc_metadata_defaults: false

  server:
    shutdown: graceful
  
  # Enhanced logging for connection monitoring
  logging:
    level:
      org.hibernate.SQL: DEBUG
      org.hibernate.type.descriptor.sql.BasicBinder: TRACE
      com.zaxxer.hikari: DEBUG
      com.zaxxer.hikari.HikariConfig: DEBUG
      com.zaxxer.hikari.HikariDataSource: DEBUG
      com.zaxxer.hikari.pool: DEBUG

# Expose metrics for connection pool monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,hikaricp
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
  jmx:
    exposure:
      include: "*"

# Externalised CV thresholds
recognition:
  confidence: 0.70
  cooldownMs: 10000
face-service:
  fastapi-url: https://kevansoon-java-facerecognition-endpoint.hf.space/face-recognition

# CORS configuration
cors:
  allowed-origins: 
    - https://cs-102-vert.vercel.app/
    - http://localhost:5173
    - http://localhost:8080
    